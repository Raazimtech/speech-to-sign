<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="description" content="Speech to Sign converts spoken or typed words into sign-language visuals with GIF playback and smart fallback modes.">
  <meta property="og:type" content="website">
  <meta property="og:title" content="Speech to Sign">
  <meta property="og:description" content="Convert speech and text to sign visuals instantly.">
  <meta property="og:image" content="marketing seo image.png">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Speech to Sign">
  <meta name="twitter:description" content="Convert speech and text to sign visuals instantly.">
  <meta name="twitter:image" content="marketing seo image.png">
  <meta name="theme-color" content="#0f7f88">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Speech to Sign">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" type="image/png" href="Gemini_Generated_Image_x0oe4fx0oe4fx0oe.png">
  <link rel="apple-touch-icon" href="Gemini_Generated_Image_x0oe4fx0oe4fx0oe.png">
  <title>Speech to Sign</title>
  <style>
    :root{--bg:#eef4fb;--card:#fff;--line:#d8e3ef;--ink:#122334;--muted:#506173;--a:#0f7f88;--a2:#0a656c}
    *{box-sizing:border-box}html,body{margin:0}
    html{-webkit-text-size-adjust:100%}
    body{font-family:Segoe UI,Tahoma,sans-serif;color:var(--ink);background:linear-gradient(160deg,#f5efe6,#d8e6f6);overflow-x:hidden}
    .splash{position:fixed;inset:0;z-index:3000;background:#fff;display:grid;place-items:center;padding:20px;opacity:1;visibility:visible;transition:opacity .3s ease,visibility .3s ease}
    .splash img{width:min(980px,92vw);max-height:88vh;object-fit:contain}
    .splash.hide{opacity:0;visibility:hidden}
    .page{min-height:100vh;padding:clamp(8px,2.5vw,20px);display:flex;align-items:center;justify-content:center}
    .card{width:min(1020px,100%);background:var(--card);border:1px solid var(--line);border-radius:18px;box-shadow:0 20px 40px rgba(18,35,52,.14);padding:clamp(12px,2.2vw,22px)}
    .head{text-align:center;margin-bottom:12px}.head h1{margin:0 0 4px;font-size:clamp(1.35rem,4.8vw,2rem)}.head p{margin:0;color:var(--muted)}
    .logo{width:clamp(64px,12vw,90px);height:auto;display:block;margin:0 auto 8px}
    .controls{display:grid;place-items:center;gap:8px;margin-bottom:12px}
    .mic{width:80px;height:80px;border-radius:50%;border:none;background:linear-gradient(145deg,#4facfe,#00f2fe);box-shadow:0 10px 20px rgba(74,144,226,.3);display:grid;place-items:center;cursor:pointer;transition:.3s}
    .mic:hover{transform:scale(1.05);box-shadow:0 15px 25px rgba(74,144,226,.4)}.mic.listening{animation:pulse 1.5s infinite}.mic svg{width:32px;height:32px;fill:#fff}
    .status{min-height:20px;font-weight:700;color:var(--muted)}.status.listening{color:var(--a2)}.status.processing{color:#8a5a00}.status.error{color:#b43f34}
    .settings{display:grid;grid-template-columns:1fr;gap:8px;margin-bottom:12px}
    .set{background:#f8fbff;border:1px solid var(--line);border-radius:12px;padding:10px}.set label{display:block;font-size:.78rem;font-weight:700;letter-spacing:.04em;text-transform:uppercase;color:var(--muted);margin-bottom:8px}
    .tog{display:grid;grid-template-columns:1fr 1fr;gap:8px}.tog button{min-height:40px;border-radius:10px;border:1px solid #c5d7e8;background:#fff;font-weight:700;cursor:pointer;padding:0 8px;white-space:nowrap}.tog button.on{border-color:var(--a);background:#e2f6f7;color:var(--a2)}
    .manual{margin-bottom:12px}.manual label{display:block;font-weight:700;margin-bottom:8px}.row{display:grid;grid-template-columns:1fr;gap:8px}
    input,select{width:100%;min-height:46px;border:1px solid var(--line);border-radius:10px;padding:10px 12px;font-size:1rem;background:#fff;color:var(--ink)}
    .btn{width:100%;min-height:46px;border:none;border-radius:10px;background:var(--a);color:#fff;font-weight:700;padding:0 16px;cursor:pointer}
    .out{display:grid;grid-template-columns:1fr;gap:10px}.blk{background:#f8fbff;border:1px solid var(--line);border-radius:12px;padding:12px}.blk h2{margin:0 0 8px;font-size:1rem}
    .trans{min-height:28px;overflow-wrap:anywhere}.show{min-height:clamp(150px,30vw,220px);border:1px dashed #95aec7;border-radius:12px;background:linear-gradient(180deg,#edf6ff,#eefaf7);display:flex;align-items:center;justify-content:center;padding:12px;text-align:center}
    .show img{width:min(340px,100%);max-height:220px;border-radius:10px;border:1px solid #bed1e3;background:#fff;box-shadow:0 10px 20px rgba(20,36,51,.16)}
    .tok{margin-top:8px;min-height:21px;color:var(--muted);font-weight:700}.ph{color:var(--muted)}
    .tcard{min-width:140px;min-height:110px;border:1px solid #bed1e3;border-radius:10px;background:#fff;display:grid;place-items:center;padding:10px}
    .tcard b{font-size:.8rem;color:var(--muted);display:block}.tcard span{font-weight:700;color:var(--a2);text-transform:uppercase;word-break:break-word}
    .act{margin-top:12px;display:flex;justify-content:center}.clear{width:100%;max-width:240px;min-height:44px;border-radius:12px;border:2px solid var(--a);background:#fff;color:var(--a2);font-weight:700;cursor:pointer}
    .footer{padding:0 clamp(8px,2vw,14px) clamp(10px,2vw,14px)}.credit{margin:auto;max-width:1020px;padding:1rem;border-top:1px solid rgba(20,36,51,.12);text-align:center;background:linear-gradient(135deg,rgba(15,127,136,.15),rgba(255,225,170,.45));border-radius:14px}
    .credit a{text-decoration:none;color:inherit;display:inline-block}.credit p{margin:0 0 6px;font-size:.72rem;letter-spacing:2.2px;text-transform:uppercase;opacity:.65}.credit strong{display:inline-block;padding:.38rem .9rem;border-radius:999px;border:1px solid rgba(20,36,51,.25)}
    .fade{animation:fin .22s ease}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(0,242,254,.7)}70%{box-shadow:0 0 0 20px rgba(0,242,254,0)}100%{box-shadow:0 0 0 0 rgba(0,242,254,0)}}
    @keyframes fin{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
    @media(min-width:720px){.settings{grid-template-columns:1fr 1fr}.row{grid-template-columns:1fr auto}.btn{width:auto;min-width:170px}}
    @media(max-width:720px){
      #signBlock{
        position:sticky;
        top:8px;
        z-index:20;
        border-color:#b8ccdf;
        box-shadow:0 10px 22px rgba(18,35,52,.12);
      }
      #signBlock h2{
        margin-bottom:6px;
      }
      #signBlock .show{
        min-height:140px;
      }
      #signBlock .show img{
        max-height:145px;
      }
    }
    @media(max-width:420px){.page{padding:8px}.card{border-radius:14px}.head h1{font-size:1.25rem}.head p{font-size:.9rem}.show img{max-height:160px}.credit strong{font-size:.88rem;padding:.34rem .8rem}}
    @media(min-width:1200px){.card{padding:24px}}
  </style>
</head>
<body>
  <div id="entrySplash" class="splash" aria-hidden="true"><img src="marketing seo image.png" alt="Speech to Sign marketing"></div>
  <main class="page">
    <section class="card">
      <header class="head"><img class="logo" src="logo (2).png" alt="Speech to Sign logo"><h1>Speech to Sign</h1><p>Speak and see it in sign language</p></header>
      <section class="controls">
        <button id="micBtn" class="mic" aria-label="Start speech recognition">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
        </button>
        <p id="status" class="status">Idle</p>
      </section>
      <section class="out">
        <div id="textBlock" class="blk"><h2>Recognized Text</h2><p id="trans" class="trans">Click the microphone and start speaking.</p></div>
        <div id="signBlock" class="blk"><h2>Sign Playback</h2><div id="show" class="show"><p class="ph">Signs will appear here one by one.</p></div><p id="tok" class="tok"></p></div>
      </section>
      <section class="settings">
        <div class="set"><label>Output</label><div class="tog"><button id="gifBtn" class="on">GIFs</button><button id="textBtn">Text</button></div></div>
        <div class="set"><label>Fallback</label><div class="tog"><button id="smartBtn" class="on">Smart</button><button id="alphaBtn">Alphabet</button></div></div>
        <div class="set"><label for="langSel">Speech Language</label><div class="row"><select id="langSel"><option value="en-US">English</option><option value="so-SO">Somali</option></select></div></div>
      </section>
      <section class="manual"><label for="input">Type text to translate</label><div class="row"><input id="input" placeholder="Example: hello, i love you"><button id="translate" class="btn">Translate Text</button></div></section>
      <section class="act"><button id="clear" class="clear">Clear</button></section>
    </section>
  </main>
  <footer class="footer"><div class="credit"><a href="https://raazimtech.github.io/Raazim-tech/" target="_blank" rel="noopener"><p>Made By</p><strong>RT Solutions</strong></a></div></footer>

  <script>
  (() => {
    const el = {
      mic: document.getElementById("micBtn"), status: document.getElementById("status"), input: document.getElementById("input"),
      translate: document.getElementById("translate"), trans: document.getElementById("trans"), show: document.getElementById("show"),
      tok: document.getElementById("tok"), clear: document.getElementById("clear"), gifBtn: document.getElementById("gifBtn"),
      textBtn: document.getElementById("textBtn"), smartBtn: document.getElementById("smartBtn"), alphaBtn: document.getElementById("alphaBtn"),
      langSel: document.getElementById("langSel")
    };

    const SIGN_FILES = [
      "100.gif","1000.gif","always.gif","americansignlanguage hello GIF.gif","baby.gif","bad.gif","brother  sister.gif","busy.gif","cannot.gif","come.gif",
      "continue.gif","cool.gif","don't understand.gif","dont understand.gif","excuse me.gif","family.gif","fast.gif","favourite.gif","fine.gif","free.gif",
      "friend.gif","give.gif","good.gif","Happy I Love You GIF by joeyahlbum.gif","happy sign language GIF by signtime.gif","happy sign language GIF.gif","holiday.gif",
      "home.gif","hope.gif","how many.gif","hungry.gif","in    out.gif","introduce sign language GIF.gif","later.gif","long.gif","Marry Sign Language GIF.gif",
      "meet.gif","more.gif","nervous.gif","not.gif","now.gif","sad sign language GIF.gif","see watch.gif","see you.gif","shes polite.gif","sick sign language GIF.gif",
      "Sign Language Change GIF.gif","sign language cry GIF.gif","Sign Language Month GIF.gif","sign language name GIF.gif","sign language numbers GIF.gif","Sign Language Play GIF.gif",
      "Sign Language Put GIF.gif","Sign Language Sgsl GIF.gif","Sign Language Stand GIF.gif","Sign Language Time GIF.gif","Sign Language Wait GIF.gif","Sign Language Walk GIF.gif",
      "Sign Language Week GIF.gif","Sign Language Year GIF.gif","Sign Language Yes GIF by @InvestInAccess.gif","sign no GIF by signtime.gif","sign please GIF by signtime.gif",
      "sign yes GIF by signtime.gif","sorry sign language GIF by signtime.gif","spelling or alphabet.gif","Stay Home Sign Language GIF.gif","sucess.gif","super.gif","thank u.gif",
      "toilet.gif","water.gif","we.gif","welcome.gif","when.gif","where.gif","which.gif","wonderful.gif","your.gif","mine.gif","sign language what GIF.gif","sign language love GIF.gif"
    ];
    const uniq = (arr) => [...new Set(arr.map(v => (v || "").trim()).filter(Boolean))];
    const fileToKey = (name) => {
      const raw = name.toLowerCase()
        .replace(/\.gif$/i, "")
        .replace(/@investinaccess/g, " ")
        .replace(/\bgif by\b.*$/i, " ")
        .replace(/\bgif\b/gi, " ")
        .replace(/\bsign language\b/gi, " ")
        .replace(/\bsgsl\b/gi, " sign ")
        .replace(/'/g, "")
        .replace(/[^a-z0-9 ]+/g, " ")
        .replace(/\s+/g, " ")
        .trim();
      const fixed = {
        "americansignlanguage hello": "hello",
        "happy i love you": "i love you",
        "introduce": "introduce",
        "marry": "marry",
        "shes polite": "she is polite",
        "sign no": "no",
        "sign yes": "yes",
        "sign please": "please",
        "sucess": "success",
        "thank u": "thank you"
      };
      return fixed[raw] || raw;
    };
    const SIGN = {};
    SIGN_FILES.forEach((file) => {
      const key = fileToKey(file);
      if (!SIGN[key]) SIGN[key] = [];
      SIGN[key].push(file);
    });

    const SO_BASE = {
      "100":"boqol","1000":"kun","always":"mar walba","baby":"ilmo","bad":"xun","brother sister":"walaal","busy":"mashquul","cannot":"ma karo","come":"kaalay",
      "continue":"sii wad","cool":"fiican","dont understand":"ma fahmin","excuse me":"i raali ahow","family":"qoys","fast":"dhakhso","favourite":"ugu jeclaan",
      "fine":"wanaagsan","free":"xor","friend":"saaxiib","give":"sii","good":"wanaag","hello":"salaan","happy":"faraxsan","holiday":"fasax","home":"guri",
      "hope":"rajo","how many":"imisa","hungry":"gaajaysan","in out":"gudaha bannaanka","introduce":"is baro","i love you":"waan ku jeclahay","later":"danbe",
      "long":"dheer","marry":"guurso","meet":"la kulan","more":"inbadan","month":"bil","name":"magac","nervous":"walwal","no":"maya","not":"maya","now":"hadda",
      "numbers":"tirooyin","play":"ciyaar","please":"fadlan","put":"dhig","sad":"murugaysan","see watch":"arag daawo","see you":"ku arki doonaa","she is polite":"iyada waa edeb",
      "sick":"xanuunsan","sign":"calaamad","sorry":"waan ka xumahay","spelling or alphabet":"higgaad ama alifbeeto","stand":"istaag","stay home":"guriga joog","success":"guul",
      "super":"aad u fiican","thank you":"mahadsanid","time":"waqti","toilet":"musqul","wait":"sug","walk":"socod","water":"biyo","we":"annaga","week":"usbuuc",
      "welcome":"soo dhawoow","when":"goorma","where":"xagee","which":"kee","wonderful":"cajiib","year":"sano","yes":"haa","your":"kaa","mine":"kayga","what":"maxay","love":"jacayl","change":"beddel","cry":"ooy"
    };
    const SO = {};
    Object.keys(SIGN).forEach((key) => { SO[key] = SO_BASE[key] || key; });

    const EN_BASE_VARIANTS = {
      "hello":["hello","hi","hey","heyy","hiya","yo","greetings","good morning","good evening"],
      "i love you":["i love you","i luv you","love you","luv u","ily","i really love you"],
      "dont understand":["dont understand","don't understand","do not understand","i dont understand","i am confused","not understand"],
      "thank you":["thank you","thanks","thank u","thx","many thanks","thanks a lot"],
      "yes":["yes","yep","yeah","yup","sure","affirmative"],
      "no":["no","nope","nah","negative","not really","never"],
      "please":["please","pls","plz","please help","please now","kindly"],
      "good":["good","great","nice","well","all good","doing good"],
      "sorry":["sorry","so sorry","my bad","apologies","forgive me","pardon me"]
      ,"mine":["mine","this is mine","it is mine","belongs to me","my own","that is mine"]
      ,"what":["what","what is","what now","which thing","what do you mean","what happened"]
      ,"love":["love","i love","feel love","in love","deep love","much love"]
    };
    const SO_BASE_VARIANTS = {
      "hello":["salaan","salaam","asc","asalamu alaikum","asalaamu calaykum","iska warran"],
      "i love you":["waan ku jeclahay","waan ku jclhy","waan kuclahay","waan ku jecelahay","waan ku jacelahay","waan ku jeclahay adiga"],
      "dont understand":["ma fahmin","maan fahmin","ma fahmaayo","ma garanayo","waan wareersanahay","si fiican uma fahmin"],
      "thank you":["mahadsanid","mahadsantahay","waad mahadsantahay","aad baad u mahadsantahay","mahadcelin","mahadsanidin"],
      "yes":["haa","haye","waayahay","waa sax","waad saxantahay","ok"],
      "no":["maya","maya maya","diidmo","ma aha","marnaba","ma doonayo"],
      "please":["fadlan","fadlan i caawi","fadlan hadda","si naxariis leh","iiga raalli noqo","fadlann"],
      "good":["wanaag","fiican","aad u fiican","wacan","ok","sax"],
      "sorry":["waan ka xumahay","raali ahow","iiga raali noqo","cafis","aad baan uga xumahay","waan ka xumahay runtii"],
      "mine":["kayga","aniga leh","kan waa kayga","waxaan leeyahay","ii gaar ah","taas waa tayda"],
      "what":["maxay","waa maxay","maxaa","maxaa jira","maxaad tiri","maxaa dhacay"],
      "love":["jacayl","waan ku jeclahay","jaceyl","jeceyl","jacayl badan","waan jecelahay"]
    };
    const buildAliases = (key) => {
      const soWord = SO[key] || key;
      const en = uniq((EN_BASE_VARIANTS[key] || []).concat([key, `my ${key}`, `the ${key}`, `need ${key}`, `want ${key}`, `${key} please`]));
      const so = uniq((SO_BASE_VARIANTS[key] || []).concat([soWord, `fadlan ${soWord}`, `${soWord} ayaan rabaa`, `${soWord} hadda`, `${soWord} ma jiraa`, `${soWord} iga caawi`]));
      return uniq(en.concat(so));
    };
    const ALIAS = {};
    Object.keys(SIGN).forEach((key) => { ALIAS[key] = buildAliases(key); });
    const TEXT = {
      en: {
        idle: "Idle",
        listening: "Listening...",
        processing: "Processing...",
        showing: "Showing",
        defaultTranscript: "Click the microphone and start speaking.",
        defaultPlaceholder: "Signs will appear here one by one.",
        noMap: "No mappable signs found for the input.",
        emptyInput: "Please speak or type a sentence first.",
        waitingInput: "Waiting for valid text input.",
        noSpeech: "No speech detected. Please try again.",
        unsupported: "Speech recognition not supported in this browser. Please use Google Chrome.",
        micDenied: "Microphone permission denied. Please allow mic access in your browser.",
        micDeniedHelp: "Microphone permission is required.",
        noMic: "No microphone was detected. Connect a mic and try again.",
        noMicHelp: "No microphone available.",
        speechErr: "Speech recognition error",
        speechErrHelp: "Could not process speech input.",
        micBlocked: "Microphone blocked",
        micMissing: "No microphone",
        error: "Error",
        micStartFail: "Could not start microphone. Please allow mic access and try again.",
        micStartFailHelp: "Microphone start failed."
      },
      so: {
        idle: "Sug",
        listening: "Dhageysanaya...",
        processing: "Habaynaya...",
        showing: "Muujinaya",
        defaultTranscript: "Riix makarafoonka kadib hadal.",
        defaultPlaceholder: "Calaamadaha ayaa halkan ku soo muuqanaya mid mid.",
        noMap: "Ma helin calaamad ku habboon qoraalka.",
        emptyInput: "Fadlan hadal ama qor jumlad marka hore.",
        waitingInput: "Waxaan sugayaa qoraal sax ah.",
        noSpeech: "Hadal lama maqal. Fadlan mar kale isku day.",
        unsupported: "Aqoonsiga codka browser-kan ma taageero. Fadlan isticmaal Chrome.",
        micDenied: "Ogolaanshaha makarafoonka waa la diiday. Fadlan ogolow makarafoonka.",
        micDeniedHelp: "Makarafoon ogolaansho ayaa loo baahan yahay.",
        noMic: "Makarafoon lama helin. Ku xidh makarafoon kadib isku day mar kale.",
        noMicHelp: "Makarafoon lama heli karo.",
        speechErr: "Khalad aqoonsiga codka",
        speechErrHelp: "Gelinta codka lama farsameyn karin.",
        micBlocked: "Makarafoon xiran",
        micMissing: "Makarafoon ma jiro",
        error: "Khalad",
        micStartFail: "Makarafoonka lama bilaabi karin. Fadlan ogolow makarafoonka kadibna isku day mar kale.",
        micStartFailHelp: "Bilowga makarafoonka wuu fashilmay."
      }
    };

    const normalizeText = t => t.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[.,!?;:"'()\-]/g," ").replace(/\s+/g," ").trim();
    const phraseMap = {}, singleWordMap = {}, aliasMap = {}, soAliasMap = {}, variantIndex = {};
    Object.entries(SIGN).forEach(([k,files]) => {
      const srcList = (Array.isArray(files) ? files : [files]).map((f) => `assets/signs/${encodeURIComponent(f)}`);
      phraseMap[k]={srcList,token:k};
      if (!k.includes(" ")) singleWordMap[k] = srcList;
    });
    Object.entries(ALIAS).forEach(([k,arr]) => arr.forEach(a => aliasMap[normalizeText(a)]=k));
    Object.entries(SO).forEach(([k,v]) => { soAliasMap[normalizeText(v)] = k; });

    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    let rec = null, listening=false, hadResult=false, manualStop=false, run=0, output="gif", fallback="smart", last="";
    const wait = ms => new Promise(r=>setTimeout(r,ms));
    const splash = document.getElementById("entrySplash");

    function setupSplash(){
      if(!splash) return;
      const holdMs = 2000;
      const fadeMs = 300;
      setTimeout(() => {
        splash.classList.add("hide");
        setTimeout(() => splash.remove(), fadeMs + 10);
      }, holdMs);
    }

    const setStatus = (kind,txt) => { el.status.className = `status ${kind}`.trim(); el.status.textContent = txt; };
    const norm = normalizeText;
    const esc = s => s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");
    const applyAliasMap = (input, map) => {
      let out = input;
      Object.keys(map).sort((a,b)=>b.length-a.length).forEach((key)=>{
        out = out.replace(new RegExp(`\\b${esc(key)}\\b`, "g"), map[key]);
      });
      return out;
    };
    const aliasNorm = t => {
      let n=norm(t).replace(/\bgoing to\b/g,"go").replace(/\bi am\b/g,"i");
      n = applyAliasMap(n, aliasMap);
      if (isSomali()) n = applyAliasMap(n, soAliasMap);
      return n;
    };
    const isSomali = () => (el.langSel?.value || "").toLowerCase().startsWith("so");
    const t = (key) => (isSomali() ? TEXT.so[key] : TEXT.en[key]);
    const displayToken = (token) => (isSomali() && SO[token] ? SO[token] : token);
    const localizeText = (text) => {
      if (!isSomali() || !text) return text;
      let out = text;
      Object.keys(SO).sort((a,b)=>b.length-a.length).forEach((k)=>{
        out = out.replace(new RegExp(`\\b${esc(k)}\\b`, "g"), SO[k]);
      });
      return out;
    };

    const clearShow = (m=t("defaultPlaceholder")) => { el.show.innerHTML=`<p class="ph">${m}</p>`; el.tok.textContent=""; };
    const tokenCard = (token,title="Text") => { el.show.innerHTML=`<div class="tcard fade"><div><b>${title}</b><span>${token}</span></div></div>`; };

    const queueFor = (words, forceAlpha) => {
      const q=[]; const max=3;
      for(let i=0;i<words.length;i++){
        const w=words[i];
        if(forceAlpha){ [...w].filter(c=>c>="a"&&c<="z").forEach(c=>q.push({src:`assets/alphabet/${c}.gif`,token:c,display:c})); continue; }
        let found=null, size=0;
        for(let s=max;s>=2;s--){ if(i+s>words.length) continue; const p=words.slice(i,i+s).join(" "); if(phraseMap[p]){found=p;size=s;break;} }
        if(found){ q.push({...phraseMap[found], display:displayToken(found)}); i+=size-1; continue; }
        if(singleWordMap[w]) { q.push({srcList:singleWordMap[w],token:w,display:displayToken(w)}); continue; }
        q.push({src:"",token:w,display:w,fallback:true,title:isSomali()?"Qoraal":"Text"});
      }
      return q;
    };

    const pickSrc = (token, srcList) => {
      if(!srcList?.length) return "";
      const i = variantIndex[token] || 0;
      variantIndex[token] = (i + 1) % srcList.length;
      return srcList[i];
    };

    const render = item => new Promise(res=>{
      if(output==="text"){ tokenCard(item.display || item.token,isSomali()?"Qoraal":"Text"); res(); return; }
      const src = pickSrc(item.token, item.srcList || (item.src ? [item.src] : []));
      if(item.fallback || !src){ tokenCard(item.display || item.token,item.title || (isSomali()?"Qoraal":"Text")); res(); return; }
      const img=new Image(); let done=false; const fin=()=>{if(done)return;done=true;res();};
      img.className="fade"; img.alt=`Sign animation for ${item.token}`; img.src=src;
      img.onload=()=>{el.show.innerHTML=""; el.show.appendChild(img); fin();};
      img.onerror=()=>{tokenCard(item.display || item.token,isSomali()?"Qoraal":"Text"); fin();};
      setTimeout(()=>{ if(!done){tokenCard(item.display || item.token,isSomali()?"Qoraal":"Text"); fin();}},450);
    });

    async function play(words, forceAlpha=false){
      run++; const id=run; const q=queueFor(words, forceAlpha);
      if(!q.length){ clearShow(t("noMap")); setStatus("",t("idle")); return; }
      for(const item of q){ if(id!==run) return; el.tok.textContent=`${t("showing")}: ${item.display || item.token}`; await render(item); await wait(1200); }
      if(id===run) setStatus("",t("idle"));
    }

    function translate(raw){
      const normalized = aliasNorm(raw);
      if(!normalized){ el.trans.textContent=t("emptyInput"); clearShow(t("waitingInput")); setStatus("",t("idle")); return; }
      const req=/\b(spell|alphabet|letter|letters)\b/g; const askAlpha=req.test(normalized);
      const clean=normalized.replace(req," ").replace(/\s+/g," ").trim(); const final=clean || normalized;
      const words=final.split(" ").filter(Boolean);
      last=final; el.trans.textContent=localizeText(final); setStatus("processing",t("processing")); play(words, fallback==="alphabet" || askAlpha);
    }

    function reset(){ run++; el.trans.textContent=t("defaultTranscript"); el.input.value=""; clearShow(); el.mic.classList.remove("listening"); el.mic.setAttribute("aria-label","Start speech recognition"); listening=false; hadResult=false; manualStop=false; last=""; setStatus("",t("idle")); }
    const replay=()=>{ if(last) translate(last); };
    const tog=(on,off)=>{on.classList.add("on");off.classList.remove("on");on.setAttribute("aria-pressed","true");off.setAttribute("aria-pressed","false");};

    function setupMic(){
      if(!SR){ el.trans.textContent=t("unsupported"); el.mic.disabled=true; setStatus("",t("idle")); return; }
      rec = new SR(); rec.lang=el.langSel?.value || "en-US"; rec.continuous=false; rec.interimResults=false; rec.maxAlternatives=1;
      rec.onstart=()=>{listening=true;hadResult=false;manualStop=false;el.mic.classList.add("listening");el.mic.setAttribute("aria-label","Stop speech recognition");setStatus("listening",t("listening"));};
      rec.onresult=(e)=>{hadResult=true; const heard=(e.results?.[0]?.[0]?.transcript||"").trim(); if(!heard){el.trans.textContent=t("noSpeech"); clearShow(t("noSpeech")); setStatus("",t("idle")); return;} translate(heard);};
      rec.onend=()=>{listening=false;el.mic.classList.remove("listening");el.mic.setAttribute("aria-label","Start speech recognition"); if(!hadResult && !manualStop){el.trans.textContent=t("noSpeech"); clearShow(t("noSpeech")); setStatus("",t("idle"));} manualStop=false;};
      rec.onerror=(e)=>{const err=e.error||"unknown-error";
        if(err==="not-allowed"||err==="service-not-allowed"){el.trans.textContent=t("micDenied"); clearShow(t("micDeniedHelp")); setStatus("error",t("micBlocked"));}
        else if(err==="audio-capture"){el.trans.textContent=t("noMic"); clearShow(t("noMicHelp")); setStatus("error",t("micMissing"));}
        else if(err==="no-speech"){el.trans.textContent=t("noSpeech"); clearShow(t("noSpeech")); setStatus("",t("idle"));}
        else{el.trans.textContent=`${t("speechErr")}: ${err}`; clearShow(t("speechErrHelp")); setStatus("error",t("error"));}
        listening=false;hadResult=false;manualStop=false;el.mic.classList.remove("listening");el.mic.setAttribute("aria-label","Start speech recognition");
      };
    }

    el.mic.addEventListener("click",()=>{ if(!rec) return; if(listening){manualStop=true;rec.stop();return;} try{rec.start();}catch{el.trans.textContent=t("micStartFail");clearShow(t("micStartFailHelp"));setStatus("",t("idle"));}});
    el.translate.addEventListener("click",()=>translate(el.input.value));
    el.input.addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault();translate(el.input.value);}});
    el.clear.addEventListener("click",()=>{ if(rec&&listening) rec.stop(); reset(); });
    el.gifBtn.addEventListener("click",()=>{output="gif";tog(el.gifBtn,el.textBtn);replay();});
    el.textBtn.addEventListener("click",()=>{output="text";tog(el.textBtn,el.gifBtn);replay();});
    el.smartBtn.addEventListener("click",()=>{fallback="smart";tog(el.smartBtn,el.alphaBtn);replay();});
    el.alphaBtn.addEventListener("click",()=>{fallback="alphabet";tog(el.alphaBtn,el.smartBtn);replay();});
    el.langSel?.addEventListener("change",()=>{
      if(!rec) return;
      rec.lang = el.langSel.value;
      if(!last){
        el.trans.textContent = t("defaultTranscript");
        clearShow();
        setStatus("", t("idle"));
      } else {
        replay();
      }
      if(listening){
        manualStop = true;
        rec.stop();
        setTimeout(()=>{ try { rec.start(); } catch {} }, 120);
      }
    });

    el.trans.textContent = t("defaultTranscript");
    clearShow(); setStatus("",t("idle")); setupSplash(); setupMic();

    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./sw.js").catch(() => {});
      });
    }
  })();
  </script>
</body>
</html>
